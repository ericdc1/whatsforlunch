@model Lunch.Core.Models.Views.ImportRestaurant

@{
    ViewBag.Title = "DisplayRestaurants";
}

<h2>Restaurants Import</h2>

@using (Html.BeginForm("SaveImports", "Management"))
{
    @Html.ValidationSummary(true)

    <fieldset>
        <legend>Restaurants List</legend>
            
        <div>Search: <input id="searchbox" type="text" url="/Management/Search" /> Minimun 3 characters required for search</div>
        
        <div id="results_container">
            @Html.Partial("_ImportRestaurantsList", Model)
        </div>    

        <p>
            <input id="SaveImports" type="button" url="/Management/SaveImports" value="Save" class="btn btn-primary" />
        </p>

    </fieldset>
}

<script type="text/javascript">

    $(document).ready(function () {

        $('#searchbox').keyup(function () {
            var url = $(this).attr('url');
            if ($(this).val().length >= 3) {
                url += '?term=' + $(this).val();
            }
            $.ajax({
                url: url,
                success: function (html) {
                    $("#results_container").html(html);
                }
            });
        });

        $("#SaveImports").click(function () {
            var url = $(this).attr('url');
            var data = '';
            for (var i = 0; i <= $(".IsSelected").length; i++) {
                if ($('.IsSelected:eq(' + i + ')').is(':checked')) {
                    if (data == '') {
                        data = "{ 'Restaurants': [ {";
                    } else {
                        data += ' }, { ';
                    }
                    var name = $('.RestaurantName:eq(' + i + ')').val().replace(/'/g, "\\'");
                    var day = $('.SpecialDay:eq(' + i + ')').val().replace(/'/g, "\\'");
                    var type = $('.RestaurantType:eq(' + i + ')').val().replace(/'/g, "\\'");
                    data += "'RestaurantName': '" + name + "', 'IsSelected': '" + $('.IsSelected:eq(' + i + ')').val() + "', 'PreferredDayOfWeek': '" + day + "', 'RestaurantTypeID': '" + type + "'";
                }
            }
            if (data != '') {
                data += '} ] }';
                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'html',
                    cache: false,
                    success: function (html) {
                        $("#results_container").html(html);
                    },
                    error: function () {
                        alert("Import FAILED");
                    }
                });
            }
        });

    });

</script>